{% extends 'pages/layout.html' %}

  {% block title %}{{ block.super }}{% endblock title %}

  {% block head%}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'homepage/home_page.css' %}">
  {% endblock head %}

  {% block page %}Topics{% endblock page %}
  
  {% block head_btn %}
    <button class="my-auto forum-button action"
          type="button"
          data-toggle="collapse"
          data-target="#add_topic">
          Add topic:
    </button>
  {% endblock head_btn %}

  {% block content %}
    <div class="collapse" id="add_topic">
    <!--form-->
      <form class="form-group mx-4" id="newTopicForm" action="/" method='POST'>
        {% csrf_token %}
        <div class="form-row">
          <input type='text' class="form-control mb-2" placeholder='Topic title' name='title' required />
        </div>
        <div class="form-row">
          <textarea class="form-control" placeholder="Topic content" name="text" required></textarea>
        </div>
          <button class="ml-3 mt-2 forum-button post" type="submit">post</button>
      </form>
    </div>
    
    <!-- Topic list -->
    <div id="topics">
        topics goes here
    </div>



<script>
const topicsContainer = document.getElementById('topics')
const topicSubmitForm = document.getElementById('newTopicForm')

topicSubmitForm.addEventListener('submit', createTopic)
getTopicsList(topicsContainer)


function getTopicsList(topicsEl) {
  handleRequest('GET', 'api_topics/').then(response => {
    var finalTopicArr = ""
    const recievedData = response.response
    console.log(recievedData)
    for (var i=0; i<recievedData.length; i++) {
      currentEl = generateTopicEl(recievedData[i])
      finalTopicArr += currentEl  
    }
    topicsContainer.innerHTML = finalTopicArr
  })
}


function handleRequest(method, url, data) {
    const promise = new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest()
        xhr.responseType = 'json'
        xhr.open(method, url)
        xhr.onload = () => {
            resolve(xhr)
        }
        xhr.send(data)
    })
    return promise
}


generateTopicEl = (element) => {
  var generatedTopicEl = "<div class='col-12 mx-auto border py-3 mb-4'>\
  <h4><a href='topic/" + element.slug + "'>" + element.title + "</a></h4>\
  <p>" + element.text + "</p>\
  </div>"
  return generatedTopicEl
}


function createTopic(event) {
  event.preventDefault()
  console.log(event)
  const topicForm = event.target
  const newFormData = new FormData(topicForm)
  handleRequest('POST', 'api_topics/create', newFormData).then(response => {
    const status = response.status
    const data = response.response
    if (status == 201) {
        getTopicsList(topicsContainer)
        topicForm.reset()
    }
  })
}

</script>


{% endblock content %}
            